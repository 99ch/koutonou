name: ğŸ”’ Security & Dependencies

on:
  schedule:
    # Tous les lundis Ã  9h UTC
    - cron: "0 9 * * 1"
  push:
    branches: [main, production_ready]
    paths:
      - "pubspec.yaml"
      - "pubspec.lock"
  workflow_dispatch:

jobs:
  # ===============================================
  # ğŸ”’ Security Audit
  # ===============================================
  security-audit:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"
          channel: "stable"
          cache: true

      - name: ğŸ“¦ Get Dependencies
        run: flutter pub get

      - name: ğŸ”’ Run Security Audit
        run: |
          dart pub global activate pana
          dart pub global run pana --no-warning --json > security-report.json

      - name: ğŸ“Š Security Report
        run: |
          echo "ğŸ”’ **Security Audit Results**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          head -20 security-report.json >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¤ Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: security-report.json
          retention-days: 30

  # ===============================================
  # ğŸ“¦ Dependency Check
  # ===============================================
  dependency-check:
    name: ğŸ“¦ Dependency Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"
          channel: "stable"
          cache: true

      - name: ğŸ“¦ Analyze Dependencies
        run: |
          flutter pub deps --json > dependencies.json
          flutter pub outdated --json > outdated.json

      - name: ğŸ“Š Dependencies Report
        run: |
          echo "ğŸ“¦ **Dependencies Analysis**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ” **Current Dependencies:**" >> $GITHUB_STEP_SUMMARY
          flutter pub deps --style=compact >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â¬†ï¸ **Outdated Packages:**" >> $GITHUB_STEP_SUMMARY
          flutter pub outdated >> $GITHUB_STEP_SUMMARY || echo "All packages up to date!" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¤ Upload Dependency Reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: |
            dependencies.json
            outdated.json
          retention-days: 30

  # ===============================================
  # ğŸš¨ Vulnerability Scan
  # ===============================================
  vulnerability-scan:
    name: ğŸš¨ Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸš¨ Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: ğŸ“¤ Upload Trivy Scan Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

  # ===============================================
  # ğŸ“ˆ Dependency Update PR
  # ===============================================
  dependency-update:
    name: ğŸ“ˆ Auto Update Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'schedule'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"
          channel: "stable"
          cache: true

      - name: ğŸ“¦ Update Dependencies
        run: |
          flutter pub upgrade

      - name: ğŸ§ª Test After Update
        run: |
          flutter pub get
          flutter analyze
          flutter test || echo "Tests failed after dependency update"

      - name: ğŸ“ Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ“¦ chore(deps): update Flutter dependencies"
          title: "ğŸ“¦ Auto: Update Flutter Dependencies"
          body: |
            ğŸ¤– **Mise Ã  jour automatique des dÃ©pendances**

            Cette PR met Ã  jour automatiquement les dÃ©pendances Flutter.

            ğŸ“‹ **Changements:**
            - Mise Ã  jour des packages vers les derniÃ¨res versions compatibles
            - Tests d'analyse et de compatibilitÃ© effectuÃ©s

            âš ï¸ **Ã€ vÃ©rifier:**
            - [ ] Tests unitaires passent
            - [ ] Tests d'intÃ©gration passent
            - [ ] Aucune rÃ©gression fonctionnelle

            ğŸ”— **GÃ©nÃ©rÃ© par:** GitHub Actions - Dependency Update Workflow
          branch: auto/dependency-update
          base: develop
          draft: false
