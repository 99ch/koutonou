name: ðŸš€ Koutonou CI/CD Pipeline

on:
  push:
    branches: [ main, production_ready, develop ]
  pull_request:
    branches: [ main, production_ready ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  # ===============================================
  # ðŸ” Code Quality & Analysis
  # ===============================================
  analyze:
    name: ðŸ“Š Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          
      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        
      - name: ðŸ” Verify Formatting
        run: dart format --output=none --set-exit-if-changed lib/ test/ tools/
        
      - name: ðŸ“Š Analyze Code
        run: flutter analyze
        
      - name: ðŸ”’ Security Analysis
        run: |
          dart pub global activate pana
          dart pub global run pana --no-warning

  # ===============================================
  # ðŸ§ª Test Suite
  # ===============================================
  test:
    name: ðŸ§ª Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: analyze
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          
      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        
      - name: ðŸ§ª Run Unit Tests
        run: flutter test --coverage --reporter json > test-results.json
        
      - name: ðŸ“Š Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: coverage/lcov.info
          name: koutonou-coverage
          fail_ci_if_error: false
          
      - name: ðŸ“‹ Test Report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: ðŸ§ª Flutter Tests
          path: test-results.json
          reporter: flutter-json

  # ===============================================
  # ðŸ—ï¸ Build Android
  # ===============================================
  build-android:
    name: ðŸ¤– Build Android
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [analyze, test]
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          
      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        
      - name: ðŸ—ï¸ Build Android APK
        run: flutter build apk --release --target-platform android-arm64
        
      - name: ðŸ—ï¸ Build Android App Bundle
        run: flutter build appbundle --release --target-platform android-arm64
        
      - name: ðŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
          
      - name: ðŸ“¤ Upload AAB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

  # ===============================================
  # ðŸŽ Build iOS (macOS runner)
  # ===============================================
  build-ios:
    name: ðŸŽ Build iOS
    runs-on: macos-latest
    timeout-minutes: 45
    needs: [analyze, test]
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        
      - name: ðŸŽ Setup iOS
        run: |
          cd ios
          pod install
          cd ..
          
      - name: ðŸ—ï¸ Build iOS (No Codesign)
        run: flutter build ios --release --no-codesign
        
      - name: ðŸ“¤ Upload iOS Build
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios/iphoneos/Runner.app
          retention-days: 30

  # ===============================================
  # ðŸŒ Build Web
  # ===============================================
  build-web:
    name: ðŸŒ Build Web
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [analyze, test]
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        
      - name: ðŸŒ Build Web
        run: flutter build web --release --web-renderer canvaskit
        
      - name: ðŸ“¤ Upload Web Build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web/
          retention-days: 30
          
      - name: ðŸš€ Deploy to GitHub Pages (main branch only)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: build/web
          cname: koutonou.app # Remplacez par votre domaine

  # ===============================================
  # ðŸ“Š Performance & Bundle Analysis
  # ===============================================
  performance-analysis:
    name: ðŸ“Š Performance Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build-android
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸ“¥ Download APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: ./artifacts
          
      - name: ðŸ“Š APK Analysis
        run: |
          ls -la ./artifacts/
          APK_SIZE=$(du -h ./artifacts/app-release.apk | cut -f1)
          echo "ðŸ¤– Android APK Size: $APK_SIZE" >> $GITHUB_STEP_SUMMARY
          
      - name: ðŸ“Š Bundle Analysis (if web built)
        if: needs.build-web.result == 'success'
        run: |
          echo "ðŸ“Š Bundle analysis placeholder - integrate with bundle analyzer tools"

  # ===============================================
  # ðŸš€ Release & Deploy (Production only)
  # ===============================================
  release:
    name: ðŸš€ Release & Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build-android, build-ios, build-web, performance-analysis]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./release-artifacts
          
      - name: ðŸ“‹ Create Release Notes
        id: release-notes
        run: |
          echo "ðŸ“± **Koutonou Release - $(date +'%Y-%m-%d %H:%M')**" > release-notes.md
          echo "" >> release-notes.md
          echo "ðŸ¤– **Android**: APK & AAB disponibles" >> release-notes.md
          echo "ðŸŽ **iOS**: Build disponible (signature requise)" >> release-notes.md
          echo "ðŸŒ **Web**: DÃ©ployÃ© sur GitHub Pages" >> release-notes.md
          echo "" >> release-notes.md
          echo "ðŸ”— **Liens**:" >> release-notes.md
          echo "- [ðŸ“± TÃ©lÃ©charger APK](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> release-notes.md
          echo "- [ðŸŒ Version Web](https://koutonou.app)" >> release-notes.md
          
      - name: ðŸ·ï¸ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body_path: release-notes.md
          files: |
            ./release-artifacts/android-apk/app-release.apk
            ./release-artifacts/android-aab/app-release.aab
          draft: false
          prerelease: false

  # ===============================================
  # ðŸ“§ Notification Success
  # ===============================================
  notify-success:
    name: ðŸ“§ Notify Success
    runs-on: ubuntu-latest
    needs: [analyze, test, build-android, build-ios, build-web]
    if: always() && (needs.analyze.result == 'success' && needs.test.result == 'success')
    
    steps:
      - name: ðŸŽ‰ Success Notification
        run: |
          echo "âœ… **Pipeline Success**" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” Analysis: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ§ª Tests: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ¤– Android: ${{ needs.build-android.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ iOS: ${{ needs.build-ios.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ Web: ${{ needs.build-web.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY

  # ===============================================
  # âŒ Notification Failure
  # ===============================================
  notify-failure:
    name: âŒ Notify Failure
    runs-on: ubuntu-latest
    needs: [analyze, test, build-android, build-ios, build-web]
    if: always() && (needs.analyze.result == 'failure' || needs.test.result == 'failure')
    
    steps:
      - name: âŒ Failure Notification
        run: |
          echo "âŒ **Pipeline Failed**" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” Analysis: ${{ needs.analyze.result }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ§ª Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”§ **Actions requises**:" >> $GITHUB_STEP_SUMMARY
          echo "- VÃ©rifier les erreurs d'analyse" >> $GITHUB_STEP_SUMMARY
          echo "- Corriger les tests en Ã©chec" >> $GITHUB_STEP_SUMMARY
          echo "- Relancer le pipeline" >> $GITHUB_STEP_SUMMARY
